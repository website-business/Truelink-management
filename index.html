<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; } 
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slideInRight { animation: slideInRight 0.3s ease-out; }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    .hidden { display: none !important; }
    #reader button { background-color: #2563eb; color: white; padding: 6px 12px; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    #reader button:hover { background-color: #1d4ed8; }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Custom Autocomplete */
    .ac-container { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 0 0 0.375rem 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-height: 12rem; overflow-y: auto; z-index: 50; }
    .ac-item { padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #374151; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
    .ac-item:hover { background-color: #dbeafe; }
  </style>
</head>
<body class="bg-gray-50 pb-10 overflow-x-hidden text-gray-800 font-sans">

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

  <!-- Offline Banner -->
  <div id="offline-banner" class="hidden bg-red-600 text-white text-center py-1.5 text-xs font-bold w-full shadow-md z-50 relative flex items-center justify-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô)
  </div>

  <header class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-10">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 002-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
        <h1 class="text-2xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      </div>
      <div id="sync-indicator" class="hidden items-center text-xs font-medium text-blue-200 animate-pulse">
        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto mt-6 px-4" id="main-content" style="display:none;">
    <!-- Tabs Menu -->
    <div class="flex bg-white rounded-t-lg shadow-sm overflow-x-auto mb-6 border-b" id="tabs-menu">
      <button onclick="switchTab('receive')" id="tab-btn-receive" class="relative flex-1 min-w-[100px] py-4 text-center font-medium transition-colors">üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</button>
      <button onclick="switchTab('dispatch')" id="tab-btn-dispatch" class="relative flex-1 min-w-[100px] py-4 text-center font-medium transition-colors">üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</button>
      <button onclick="switchTab('summary')" id="tab-btn-summary" class="relative flex-1 min-w-[100px] py-4 text-center font-medium transition-colors">üì¶ ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</button>
      <button onclick="switchTab('shops')" id="tab-btn-shops" class="relative flex-1 min-w-[100px] py-4 text-center font-medium transition-colors">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <button onclick="switchTab('history')" id="tab-btn-history" class="relative flex-1 min-w-[100px] py-4 text-center font-medium transition-colors">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      <button onclick="switchTab('alerts')" id="tab-btn-alerts" class="relative flex-1 min-w-[120px] py-4 text-center font-medium transition-colors">
        ‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        <span id="alert-badge" class="hidden absolute top-2 right-2 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
      </button>
    </div>

    <div class="bg-white p-6 rounded-b-lg shadow-md border border-gray-100 min-h-[500px]">
      
      <!-- TAB: ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ -->
      <div id="tab-receive" class="hidden space-y-5 animate-fadeIn max-w-2xl mx-auto">
        <h2 class="text-xl font-bold text-gray-800 border-l-4 border-blue-500 pl-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="date" id="rec-date" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (Parts)</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <input type="text" id="rec-parts" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" autocomplete="off" onfocus="showAC('rec-parts', state.existingPartsCodes)" oninput="handlePartsChange('rec'); showAC('rec-parts', state.existingPartsCodes)" />
              </div>
              <button onclick="openScanner('rec')" class="bg-blue-100 text-blue-700 p-2.5 rounded-md hover:bg-blue-200">üì∑</button>
            </div>
          </div>
          
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span></label>
            <input type="text" id="rec-product" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" autocomplete="off" onfocus="showAC('rec-product', state.existingProducts)" oninput="handleProductChange('rec'); showAC('rec-product', state.existingProducts)" />
          </div>
          
          <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="text-red-500">*</span></label><input type="number" min="0" step="0.01" id="rec-qty" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" min="0" step="0.01" id="rec-price" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>
          
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ <span class="text-red-500">*</span></label>
            <input type="text" id="rec-shop" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" autocomplete="off" onfocus="showAC('rec-shop', state.existingShops)" oninput="showAC('rec-shop', state.existingShops)" />
          </div>
        </div>
        <button id="btn-save-rec" onclick="handleSubmit('receive')" class="w-full mt-6 text-white font-bold py-3.5 px-4 rounded-md shadow bg-blue-600 hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
      </div>

      <!-- TAB: ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å -->
      <div id="tab-dispatch" class="hidden space-y-5 animate-fadeIn max-w-2xl mx-auto">
        <h2 class="text-xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="date" id="dis-date" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" onchange="checkDispatchWarning()" /></div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (Parts)</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <input type="text" id="dis-parts" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πÅ‡∏Å‡∏ô" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" autocomplete="off" onfocus="showAC('dis-parts', state.existingPartsCodes)" oninput="handlePartsChange('dis'); showAC('dis-parts', state.existingPartsCodes)" />
              </div>
              <button onclick="openScanner('dis')" class="bg-orange-100 text-orange-700 p-2.5 rounded-md hover:bg-orange-200">üì∑</button>
            </div>
          </div>
          
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å <span class="text-red-500">*</span></label>
            <input type="text" id="dis-product" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" autocomplete="off" onfocus="showAC('dis-product', state.existingProducts)" oninput="handleProductChange('dis'); showAC('dis-product', state.existingProducts)" />
            <p id="dis-stock-warning" class="text-xs font-bold mt-1 hidden"></p>
          </div>
          
          <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å <span class="text-red-500">*</span></label><input type="number" min="0" step="0.01" id="dis-qty" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" /></div>
          
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label>
            <input type="text" id="dis-vehicle" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full p-2.5 border border-gray-300 rounded-md outline-none focus:ring-2 focus:ring-orange-500" autocomplete="off" onfocus="showAC('dis-vehicle', state.existingVehicles)" oninput="checkDispatchWarning(); showAC('dis-vehicle', state.existingVehicles)" />
            <div id="dis-lifespan-warning" class="mt-2 text-sm text-red-600 bg-red-100 p-2.5 rounded border border-red-200 hidden"></div>
          </div>
        </div>
        <button id="btn-save-dis" onclick="handleSubmit('dispatch')" class="w-full mt-6 text-white font-bold py-3.5 px-4 rounded-md shadow bg-orange-600 hover:bg-orange-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</button>
      </div>

      <!-- TAB: ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á -->
      <div id="tab-summary" class="hidden space-y-4 animate-fadeIn">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
          <h2 class="text-xl font-bold text-gray-800 border-l-4 border-green-500 pl-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h2>
          <div class="flex gap-2 w-full sm:w-auto">
            <input type="text" id="summary-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏≤‡∏£‡πå‡∏ó..." oninput="renderSummary()" class="flex-1 p-2 border border-gray-300 rounded-md text-sm outline-none focus:ring-2 focus:ring-green-500 w-full sm:w-64" />
            <button onclick="openScanner('summary')" class="bg-green-100 text-green-700 px-3 py-2 rounded-md hover:bg-green-200" title="‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">üì∑</button>
          </div>
        </div>
        <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr><th class="px-6 py-3.5 text-left text-xs font-bold text-gray-600 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà)</th><th class="px-6 py-3.5 text-right text-sm font-bold text-blue-800 uppercase w-32">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr>
            </thead>
            <tbody id="summary-tbody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

      <!-- TAB: ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ -->
      <div id="tab-shops" class="hidden space-y-6 animate-fadeIn">
        <h2 class="text-xl font-bold text-gray-800 border-l-4 border-indigo-500 pl-3 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <select id="shops-select" onchange="renderShops()" class="w-full md:w-1/2 p-2.5 border rounded-md text-sm outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
        </select>
        <div id="shops-table-container" class="overflow-x-auto border border-gray-200 rounded-lg mt-4 shadow-sm hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-600">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr>
            </thead>
            <tbody id="shops-tbody" class="bg-white divide-y divide-gray-100"></tbody>
            <tfoot class="bg-indigo-50 border-t border-indigo-100">
              <tr><td colspan="4" id="shops-total" class="px-4 py-3 text-right text-sm font-bold text-indigo-900"></td></tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- TAB: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
      <div id="tab-history" class="hidden space-y-6 animate-fadeIn">
        <h2 class="text-xl font-bold text-gray-800 border-l-4 border-purple-500 pl-3 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
        <div class="bg-purple-50 p-4 rounded-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
          <div><label class="block text-xs font-bold text-purple-800 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="hist-type" onchange="renderHistory()" class="w-full p-2 border rounded text-sm outline-none"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å">‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</option></select></div>
          <div><label class="block text-xs font-bold text-purple-800 mb-1">‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label><select id="hist-product" onchange="renderHistory()" class="w-full p-2 border rounded text-sm outline-none bg-white"><option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option></select></div>
          <div><label class="block text-xs font-bold text-purple-800 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><select id="hist-vehicle" onchange="renderHistory()" class="w-full p-2 border rounded text-sm outline-none"><option value="">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô/‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option></select></div>
          <div><label class="block text-xs font-bold text-purple-800 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="hist-start" onchange="renderHistory()" class="w-full p-2 border rounded text-sm outline-none" /></div>
          <div><label class="block text-xs font-bold text-purple-800 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="hist-end" onchange="renderHistory()" class="w-full p-2 border rounded text-sm outline-none" /></div>
        </div>
        <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr><th class="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-3 py-3 text-right text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="px-3 py-3 text-center text-xs font-bold text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
            </thead>
            <tbody id="history-tbody" class="bg-white divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <!-- TAB: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
      <div id="tab-alerts" class="hidden space-y-8 animate-fadeIn">
        <div>
          <h2 class="text-xl font-bold text-orange-600 border-l-4 border-orange-500 pl-3 mb-4">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</h2>
          <div class="overflow-x-auto border border-orange-200 rounded-lg shadow-sm">
            <table class="min-w-full divide-y divide-orange-200">
              <thead class="bg-orange-50">
                <tr><th class="px-4 py-3 text-left text-xs font-bold text-orange-800">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà(‡∏´‡∏•‡∏±‡∏Å)</th><th class="px-4 py-3 text-left text-xs font-bold text-orange-800">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-4 py-3 text-center text-xs font-bold text-orange-800">‡∏à‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</th><th class="px-4 py-3 text-right text-xs font-bold text-orange-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr>
              </thead>
              <tbody id="alerts-lowstock-tbody" class="bg-white divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h2 class="text-xl font-bold text-red-800 border-l-4 border-red-600 pl-3 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</h2>
          <div class="overflow-x-auto border border-red-200 rounded-lg shadow-sm">
            <table class="min-w-full divide-y divide-red-200">
              <thead class="bg-red-50">
                <tr><th class="px-4 py-3 text-left text-xs font-bold text-red-800">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</th><th class="px-4 py-3 text-left text-xs font-bold text-red-800">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th><th class="px-4 py-3 text-left text-xs font-bold text-red-800">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-4 py-3 text-center text-xs font-bold text-red-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="px-4 py-3 text-right text-xs font-bold text-red-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
              </thead>
              <tbody id="alerts-dispatch-tbody" class="bg-white divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Loading Screen -->
  <div id="loading-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
    <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    <div class="text-xl font-bold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <!-- --- MODALS --- -->

  <!-- Edit Modal -->
  <div id="modal-edit" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 animate-fadeIn">
      <h3 class="text-xl font-bold text-blue-800 mb-4 border-b pb-2" id="edit-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-xs font-bold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="edit-date" class="w-full p-2 border rounded text-sm"/></div>
        
        <div id="edit-wrap-parts" class="relative"></div>
        <div id="edit-wrap-product" class="col-span-2 relative"></div>
        
        <div><label class="block text-xs font-bold text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" id="edit-qty" class="w-full p-2 border rounded text-sm"/></div>
        <div id="edit-wrap-extra" class="col-span-2 grid grid-cols-2 gap-4"></div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button onclick="closeModal('modal-edit')" class="px-4 py-2 border rounded text-gray-600 bg-gray-50 hover:bg-gray-100 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btn-edit-save" onclick="executeEdit()" class="px-4 py-2 text-white rounded font-bold transition-colors bg-blue-600 hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="modal-detail" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[85vh] flex flex-col animate-fadeIn">
      <div class="p-5 border-b flex justify-between items-start bg-gray-50 rounded-t-lg">
        <div class="w-full" id="detail-header-normal">
          <div class="flex items-center gap-3">
            <h3 class="text-xl font-bold text-gray-800" id="detail-title"></h3>
            <button onclick="openGlobalRename()" class="text-blue-500 hover:text-blue-700 text-sm bg-blue-50 px-2 py-1 rounded border border-blue-200">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
          </div>
          <p class="text-sm text-blue-600 font-semibold mt-1" id="detail-balance"></p>
        </div>
        
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏≠‡∏á -->
        <div class="w-full pr-8 hidden" id="detail-header-rename">
          <div class="bg-blue-50 p-4 rounded border border-blue-200 mb-2">
            <p class="text-xs font-bold text-blue-800 mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</p>
            <div class="flex flex-col gap-3">
              <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                <label class="text-sm font-bold text-gray-700 sm:w-20">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
                <input type="text" id="rename-name" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà" class="p-2 border rounded text-sm flex-1 w-full" />
              </div>
              
              <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å -->
              <div id="rename-parts-container" class="flex flex-col gap-2"></div>
              
              <div class="flex justify-end gap-2 mt-2 border-t border-blue-100 pt-3">
                <button onclick="closeGlobalRename()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-rename-save" onclick="executeGlobalRename()" class="text-white px-4 py-2 rounded text-sm font-bold bg-blue-600 hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
              </div>
            </div>
          </div>
        </div>
        <button onclick="closeModal('modal-detail')" class="text-gray-400 hover:text-red-500 ml-4 text-xl">‚ùå</button>
      </div>

      <!-- ‡πÅ‡∏ñ‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î (Slim Toolbar) -->
      <div class="px-5 py-2.5 border-b bg-yellow-50 flex flex-wrap items-center justify-between gap-3 sm:gap-4">
        <div class="flex flex-wrap items-center gap-4 w-full sm:w-auto">
          <div class="flex items-center gap-2">
            <label class="text-xs font-bold text-yellow-800">‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô):</label>
            <input type="number" id="detail-lifespan" placeholder="-" class="w-16 p-1 text-sm border border-yellow-300 rounded outline-none focus:ring-1 focus:ring-yellow-500 text-center shadow-inner" />
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs font-bold text-orange-800">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å <span class="hidden sm:inline">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤</span>:</label>
            <input type="number" id="detail-minstock" placeholder="-" class="w-16 p-1 text-sm border border-orange-300 rounded outline-none focus:ring-1 focus:ring-orange-500 text-center shadow-inner" />
          </div>
        </div>
        <button id="btn-save-settings" onclick="saveSettings()" class="w-full sm:w-auto text-white text-xs font-bold py-1.5 px-5 rounded transition-colors bg-yellow-600 hover:bg-yellow-700 shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      </div>
      
      <div class="px-6 py-3 bg-gray-50 border-b flex items-center gap-2">
        <label class="text-sm font-bold text-gray-700">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞:</label>
        <select id="detail-filter" onchange="renderDetailTable()" class="p-1 border border-gray-300 rounded text-sm outline-none"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å">‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</option></select>
      </div>
      <div class="p-0 overflow-y-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-white sticky top-0 shadow-sm"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏£‡πâ‡∏≤‡∏ô</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="detail-tbody" class="bg-white divide-y divide-gray-100"></tbody>
        </table>
      </div>
      <div class="p-3 border-t bg-gray-50 text-right"><button onclick="closeModal('modal-detail')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 font-bold rounded">‡∏õ‡∏¥‡∏î</button></div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="modal-scanner" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-[100] p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative">
      <button onclick="closeScanner()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl z-10">&times;</button>
      <h3 class="text-lg font-bold mb-4 text-center text-gray-800">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / QR Code</h3>
      <div id="reader" class="w-full overflow-hidden rounded-md border border-gray-300 bg-white min-h-[250px] text-gray-800"></div>
      <p class="text-xs text-gray-500 text-center mt-4">‡∏´‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠ Localhost</p>
    </div>
  </div>

  <!-- Prompt Modal (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö) -->
  <div id="modal-prompt" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-green-700 mb-4">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
      <div class="space-y-4">
        <div><label class="block text-sm font-bold mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label><textarea id="prompt-reason" class="w-full p-2 border rounded outline-none h-20" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏á‡πÅ‡∏ï‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô, ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î..."></textarea></div>
        <div><label class="block text-sm font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö *</label><input type="text" id="prompt-checker" class="w-full p-2 border rounded outline-none" placeholder="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô" /></div>
      </div>
      <div class="mt-6 flex justify-end gap-2"><button onclick="closeModal('modal-prompt')" class="px-4 py-2 bg-gray-200 rounded font-bold hover:bg-gray-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="btn-prompt-save" onclick="executePrompt()" class="px-4 py-2 text-white rounded font-bold bg-green-600 hover:bg-green-700 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button></div>
    </div>
  </div>

  <!-- Detail Alert Modal (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö) -->
  <div id="modal-alert-detail" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full">
      <h3 class="text-lg font-bold text-red-600 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≥</h3>
      <div id="alert-detail-content" class="text-sm space-y-2"></div>
      <button onclick="closeModal('modal-alert-detail')" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 py-2 rounded font-bold transition-colors">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Reason Display Modal (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß) -->
  <div id="modal-reason-detail" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 animate-fadeIn">
      <h3 class="text-lg font-bold text-green-700 mb-4 flex items-center gap-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      </h3>
      <div class="space-y-3 text-sm">
        <div>
          <span class="block font-bold text-gray-700 mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å:</span>
          <div id="display-reason" class="bg-gray-50 p-3 rounded border text-gray-600 whitespace-pre-line min-h-[3rem]"></div>
        </div>
        <div>
          <span class="block font-bold text-gray-700 mb-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</span>
          <div id="display-checker" class="bg-gray-50 p-2 rounded border text-gray-800 font-semibold"></div>
        </div>
      </div>
      <button onclick="closeModal('modal-reason-detail')" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 py-2 rounded font-bold transition-colors">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>
  </div>

  <!-- Custom Alert/Confirm -->
  <div id="modal-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] p-4">
    <div class="bg-white rounded-lg p-6 text-center shadow-xl w-80">
      <h3 id="alert-title" class="text-lg font-bold mb-2"></h3>
      <p id="alert-msg" class="mb-4 text-sm whitespace-pre-line"></p>
      <button id="alert-btn" onclick="closeModal('modal-alert')" class="w-full text-white font-bold py-2 rounded">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>

  <div id="modal-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] p-4">
    <div class="bg-white rounded-lg p-6 shadow-xl max-w-md w-full">
      <h3 class="text-lg font-bold mb-3 flex items-center gap-2">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
      <p id="confirm-msg" class="mb-6 text-sm text-gray-600 whitespace-pre-line leading-relaxed"></p>
      <div class="flex flex-col sm:flex-row-reverse gap-2">
        <button id="confirm-yes" class="w-full sm:w-auto px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold transition-colors"></button>
        <button id="confirm-no" class="w-full sm:w-auto px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-bold transition-colors"></button>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyRfv6La0jrLr_rtmv3qQeJ7Pz0sIsz2uwG1_nd4F9GyjN6By_xgKFIrZPldM_xTdQJwQ/exec';
    
    let state = {
      transactions: [], vehicles: [], itemSettings: {}, inventory: {},
      existingProducts: [], existingPartsCodes: [], existingShops: [], existingVehicles: [],
      barcodeMap: {}, 
      activeTab: 'receive',
      isOnline: navigator.onLine,
      syncTasks: [],
      scannerOrigin: null,
      html5QrcodeScanner: null,
      editingTx: null, promptTx: null, detailItem: null,
      alertData: [], lowStockAlerts: []
    };

    const getEl = id => document.getElementById(id);
    const formatDate = d => new Date(d).toISOString().split('T')[0];
    
    const parseCSV = (csvText) => {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
      if (lines.length === 0) return [];
      const parseRow = (row) => {
        const result = []; let insideQuote = false; let currentValue = "";
        for (let i = 0; i < row.length; i++) {
          const char = row[i];
          if (char === '"') insideQuote = !insideQuote;
          else if (char === ',' && !insideQuote) { result.push(currentValue); currentValue = ""; } 
          else currentValue += char;
        }
        result.push(currentValue); return result;
      };
      const headers = parseRow(lines[0]).map(h => h.trim());
      const result = [];
      for (let i = 1; i < lines.length; i++) {
        const obj = {}; const currentLine = parseRow(lines[i]);
        headers.forEach((header, index) => {
          let val = currentLine[index] !== undefined ? currentLine[index].trim() : '';
          if(val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length-1);
          obj[header] = val;
        });
        obj._rowIndex = i + 1; 
        result.push(obj);
      }
      return result;
    };

    const fetchWithTimeout = async (url, options, timeout = 15000) => {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id); return response;
      } catch (error) { clearTimeout(id); throw error; }
    };
    
    window.onload = async () => {
      getEl('rec-date').value = formatDate(new Date());
      getEl('dis-date').value = formatDate(new Date());
      
      window.addEventListener('online', () => { state.isOnline = true; renderNetwork(); });
      window.addEventListener('offline', () => { state.isOnline = false; renderNetwork(); });

      const cachedTrans = localStorage.getItem('cachedTransactions_v14');
      const cachedVehicles = localStorage.getItem('cachedVehicles_v14');
      const cachedItemSettings = localStorage.getItem('cachedItemSettings_v14');
      
      if (cachedTrans && cachedVehicles) {
        state.transactions = JSON.parse(cachedTrans);
        state.vehicles = JSON.parse(cachedVehicles);
        if(cachedItemSettings) state.itemSettings = JSON.parse(cachedItemSettings);
        computeDerivedState();
        getEl('loading-screen').classList.add('hidden');
        getEl('main-content').style.display = 'block';
        getEl('sync-indicator').classList.remove('hidden');
        switchTab('receive');
      }

      try {
        const [vRes, tRes, lRes] = await Promise.all([
          fetchWithTimeout('https://docs.google.com/spreadsheets/d/e/2PACX-1vTsqgQEO--X1boq_GQ0zBA-GSH5PubM3tMFaqd3m2NnY4AFBmJt7XjDEZ8lSfqS3SeyZ-xLLbqwJC4q/pub?gid=0&single=true&output=csv', {}, 10000),
          fetchWithTimeout('https://docs.google.com/spreadsheets/d/e/2PACX-1vTsqgQEO--X1boq_GQ0zBA-GSH5PubM3tMFaqd3m2NnY4AFBmJt7XjDEZ8lSfqS3SeyZ-xLLbqwJC4q/pub?gid=1269813507&single=true&output=csv', {}, 10000),
          fetchWithTimeout('https://docs.google.com/spreadsheets/d/e/2PACX-1vTsqgQEO--X1boq_GQ0zBA-GSH5PubM3tMFaqd3m2NnY4AFBmJt7XjDEZ8lSfqS3SeyZ-xLLbqwJC4q/pub?gid=140236194&single=true&output=csv', {}, 10000)
        ]);

        state.vehicles = parseCSV(await vRes.text());
        state.transactions = parseCSV(await tRes.text());
        
        const lifespanData = parseCSV(await lRes.text());
        state.itemSettings = {};
        lifespanData.forEach(row => {
          if (row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']) {
            state.itemSettings[row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].trim()] = {
              lifespan: row['‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'] || '',
              minStock: row['‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥'] || ''
            };
          }
        });

        localStorage.setItem('cachedVehicles_v14', JSON.stringify(state.vehicles));
        localStorage.setItem('cachedTransactions_v14', JSON.stringify(state.transactions));
        localStorage.setItem('cachedItemSettings_v14', JSON.stringify(state.itemSettings));

      } catch (e) { console.error("Fetch error", e); } 
      finally {
        computeDerivedState();
        getEl('loading-screen').classList.add('hidden');
        getEl('sync-indicator').classList.add('hidden');
        getEl('main-content').style.display = 'block';
        if(state.activeTab === 'receive') switchTab('receive'); 
      }
    };

    function computeDerivedState() {
      state.inventory = {};
      state.barcodeMap = {};
      const sortedTrans = [...state.transactions].sort((a, b) => new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
      
      sortedTrans.forEach(curr => {
        const product = (curr['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim();
        const type = curr['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'];
        const qty = parseFloat(curr['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || 0);
        const parts = (curr['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] || '').trim();

        if (!product) return;
        if (!state.inventory[product]) state.inventory[product] = { in: 0, out: 0, balance: 0, partsCodes: new Set(), mainPart: '' };
        
        if (parts !== '') {
           state.inventory[product].partsCodes.add(parts);
           state.inventory[product].mainPart = parts; 
        }

        if (type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
          state.inventory[product].in += qty;
          state.inventory[product].balance += qty;
        } else if (type === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å') {
          state.inventory[product].out += qty;
          state.inventory[product].balance -= qty;
        }
      });

      state.existingProducts = Object.keys(state.inventory).sort();
      
      state.existingProducts.forEach(p => {
         state.inventory[p].partsCodes.forEach(code => {
             state.barcodeMap[code.toLowerCase()] = p;
         });
      });

      state.existingPartsCodes = Object.keys(state.barcodeMap).map(k => state.inventory[state.barcodeMap[k]].mainPart).filter(Boolean).sort();
      state.existingShops = [...new Set(state.transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' && t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']).map(t => t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']))].filter(Boolean);
      
      const masterVeh = [];
      state.vehicles.forEach(v => {
          const keys = Object.keys(v);
          if (keys.length > 1 && v[keys[1]]) masterVeh.push(String(v[keys[1]]).trim());
          if (v['‡∏£‡∏´‡∏±‡∏™']) masterVeh.push(String(v['‡∏£‡∏´‡∏±‡∏™']).trim());
          if (v['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']) masterVeh.push(String(v['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']).trim());
          if (v['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô']) masterVeh.push(String(v['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô']).trim());
      });
      const txVeh = state.transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'])).map(t => String(t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å']).trim());
      state.existingVehicles = [...new Set([...masterVeh, ...txVeh])].filter(Boolean).sort();

      // Alerts
      state.alertData = [];
      const dispatches = state.transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å');
      const grouped = {};
      dispatches.forEach(t => {
          const v = t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'];
          const p = (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
          if (!v || !p) return;
          const key = `${v}_${p}`;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(t);
      });

      Object.values(grouped).forEach(group => {
          group.sort((a, b) => {
             const dDiff = new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
             if(dDiff !== 0) return dDiff;
             return (a._rowIndex || 0) - (b._rowIndex || 0); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏á
          });
          
          for (let i = 1; i < group.length; i++) {
              const currTx = group[i];
              const prevTx = group[i-1];
              const pName = (currTx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
              const targetLifespan = state.itemSettings[pName]?.lifespan;
              if (targetLifespan) {
                  const diffDays = (new Date(currTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(prevTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])) / 86400000;
                  if (diffDays >= 0 && diffDays / 30.44 < parseFloat(targetLifespan)) {
                      if (!(currTx['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'] || '').includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') && !state.alertData.some(a => a._rowIndex === currTx._rowIndex)) {
                          state.alertData.push(currTx);
                      }
                  }
              }
          }
      });
      state.alertData.sort((a, b) => new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));

      state.lowStockAlerts = [];
      state.existingProducts.forEach(product => {
        const balance = state.inventory[product].balance;
        const minStr = state.itemSettings[product]?.minStock;
        if (minStr && minStr.trim() !== '') {
          const th = parseFloat(minStr);
          if (!isNaN(th) && balance <= th) state.lowStockAlerts.push({ product, partsCode: state.inventory[product].mainPart, balance, threshold: th });
        }
      });
      state.lowStockAlerts.sort((a, b) => a.balance - b.balance);

      updateSelectOptions();
      renderAllTables();
    }

    // --- Custom Autocomplete ---
    window.showAC = function(inputId, optionsList) {
      const input = getEl(inputId);
      const val = input.value.toLowerCase().trim();
      let ac = getEl(inputId + '-ac');
      
      if(!ac) {
        ac = document.createElement('div');
        ac.id = inputId + '-ac';
        ac.className = 'ac-container hidden';
        input.parentNode.classList.add('relative');
        input.parentNode.appendChild(ac);
      }
      
      const filtered = optionsList.filter(item => item.toLowerCase().includes(val));
      if(filtered.length === 0 || (filtered.length === 1 && filtered[0].toLowerCase() === val)) {
        ac.classList.add('hidden');
        return;
      }
      
      ac.innerHTML = filtered.map(item => `<div class="ac-item" onclick="selectAC('${inputId}', '${item.replace(/'/g, "\\'")}')">${item}</div>`).join('');
      ac.classList.remove('hidden');
    }

    window.selectAC = function(inputId, val) {
      getEl(inputId).value = val;
      const ac = getEl(inputId + '-ac');
      if(ac) ac.classList.add('hidden');
      
      if(inputId.includes('parts')) handlePartsChange(inputId.split('-')[0]);
      if(inputId.includes('product')) handleProductChange(inputId.split('-')[0]);
      if(inputId.includes('vehicle')) checkDispatchWarning();
    }

    document.addEventListener('click', (e) => {
      document.querySelectorAll('.ac-container').forEach(el => {
        const inputId = el.id.replace('-ac', '');
        const inputEl = document.getElementById(inputId);
        if(!el.contains(e.target) && e.target !== inputEl) {
            el.classList.add('hidden');
        }
      });
    });

    function updateSelectOptions() {
      getEl('shops-select').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>' + state.existingShops.map(s => `<option value="${s}">${s}</option>`).join('');
      getEl('hist-product').innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>' + state.existingProducts.map(p => `<option value="${p}">${p}</option>`).join('');
      getEl('hist-vehicle').innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô/‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>' + state.existingVehicles.map(v => `<option value="${v}">${v}</option>`).join('');
    }

    function renderNetwork() {
      const banner = getEl('offline-banner');
      if(state.isOnline) banner.classList.add('hidden'); else banner.classList.remove('hidden');
    }

    function switchTab(tab) {
      state.activeTab = tab;
      ['receive', 'dispatch', 'summary', 'shops', 'history', 'alerts'].forEach(t => {
        getEl(`tab-${t}`).classList.add('hidden');
        const btn = getEl(`tab-btn-${t}`);
        const minW = t === 'alerts' ? 'min-w-[120px]' : 'min-w-[100px]';
        btn.className = `relative flex-1 ${minW} py-4 text-center font-medium transition-colors ${t === tab ? getTabColor(t) : 'text-gray-500 hover:bg-gray-50'}`;
      });
      getEl(`tab-${tab}`).classList.remove('hidden');
      if(tab === 'summary') renderSummary();
      if(tab === 'shops') renderShops();
      if(tab === 'history') renderHistory();
      if(tab === 'alerts') renderAlerts();
    }

    function getTabColor(tab) {
      if(tab==='receive') return 'bg-blue-50 text-blue-700 border-b-2 border-blue-700';
      if(tab==='dispatch') return 'bg-orange-50 text-orange-600 border-b-2 border-orange-600';
      if(tab==='summary') return 'bg-green-50 text-green-700 border-b-2 border-green-700';
      if(tab==='shops') return 'bg-indigo-50 text-indigo-700 border-b-2 border-indigo-700';
      if(tab==='history') return 'bg-purple-50 text-purple-700 border-b-2 border-purple-700';
      if(tab==='alerts') return 'bg-red-50 text-red-700 border-b-2 border-red-700';
    }

    function handlePartsChange(prefix) {
      const code = getEl(`${prefix}-parts`).value.trim();
      if(code !== '') {
        const matchedProduct = state.barcodeMap[code.toLowerCase()];
        if(matchedProduct) {
          getEl(`${prefix}-product`).value = matchedProduct;
          if(prefix === 'dis') checkDispatchWarning();
        }
      }
    }

    function handleProductChange(prefix) {
      const name = getEl(`${prefix}-product`).value.trim();
      if(state.inventory[name] && state.inventory[name].mainPart) {
        const currentPart = getEl(`${prefix}-parts`).value.trim();
        if(!currentPart || state.barcodeMap[currentPart.toLowerCase()] !== name) {
            getEl(`${prefix}-parts`).value = state.inventory[name].mainPart;
        }
      } else if (name === '') {
        getEl(`${prefix}-parts`).value = '';
      }
      if(prefix === 'dis') checkDispatchWarning();
    }

    function checkDispatchWarning() {
      const prod = getEl('dis-product').value.trim();
      const veh = getEl('dis-vehicle').value.trim();
      const warnBox = getEl('dis-lifespan-warning');
      const stockBox = getEl('dis-stock-warning');
      
      if(prod && state.inventory[prod]) {
        stockBox.classList.remove('hidden');
        stockBox.innerText = `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${state.inventory[prod].balance}`;
        stockBox.className = `text-xs font-bold mt-1 ${state.inventory[prod].balance <= 0 ? 'text-red-500' : 'text-blue-600'}`;
      } else {
        stockBox.classList.add('hidden');
      }

      warnBox.classList.add('hidden');
      const targetLifespan = state.itemSettings[prod]?.lifespan;
      if(!prod || !veh || !targetLifespan) return;

      const past = state.transactions.filter(t => {
          const tVeh = (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'] || '').trim();
          return t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()===prod && tVeh===veh;
      }).sort((a,b)=> {
          const dDiff = new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
          return dDiff !== 0 ? dDiff : Math.abs(b._rowIndex || 0) - Math.abs(a._rowIndex || 0); // ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
      });
      
      if(past.length > 0) {
        const curDateStr = getEl('dis-date').value;
        const diffDays = (new Date(curDateStr) - new Date(past[0]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])) / 86400000;
        const ms = diffDays/30.44;
        
        // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏Å‡∏£‡∏ì‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï (‡∏ö‡∏±‡πä‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
        if(diffDays >= 0 && ms < parseFloat(targetLifespan)) {
          let timeText = diffDays < 30 ? `${Math.floor(diffDays)} ‡∏ß‡∏±‡∏ô` : `${ms.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
          warnBox.classList.remove('hidden');
          warnBox.innerHTML = `<strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${past[0]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']} <br/>(‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ ${timeText} ‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${targetLifespan} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`;
        }
      }
    }

    function closeModal(id) { getEl(id).classList.add('hidden'); }
    function openModal(id) { getEl(id).classList.remove('hidden'); }
    
    function showAlert(msg, type='info') {
      getEl('alert-msg').innerText = msg;
      getEl('alert-title').innerText = type==='error'?'‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î':(type==='warning'?'‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô':'‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      const btn = getEl('alert-btn');
      btn.className = `w-full text-white font-bold py-2 rounded ${type==='error'?'bg-red-600 hover:bg-red-700':(type==='warning'?'bg-orange-500 hover:bg-orange-600':'bg-blue-600 hover:bg-blue-700')}`;
      openModal('modal-alert');
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö Confirm (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)
    function showConfirm(msg, onYes, onNo = null, txtYes='‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', txtNo='‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') {
      getEl('confirm-msg').innerText = msg;
      const bY = getEl('confirm-yes'), bN = getEl('confirm-no');
      
      bY.innerText = txtYes; 
      bY.onclick = () => { 
          closeModal('modal-confirm'); 
          if(typeof onYes === 'function') onYes(); 
      };
      
      bN.innerText = txtNo; 
      bN.onclick = () => { 
          closeModal('modal-confirm'); 
          if(typeof onNo === 'function') onNo(); 
      };
      
      openModal('modal-confirm');
    }

    function showReasonDetail(rowIndex) {
      const tx = state.transactions.find(t => t._rowIndex === rowIndex);
      if(!tx) return;
      
      const reason = tx['‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'] && tx['‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'] !== '-' ? tx['‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'] : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
      const checker = tx['‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢'] && tx['‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢'] !== '-' ? tx['‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢'] : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
      
      getEl('display-reason').innerText = reason;
      getEl('display-checker').innerText = checker;
      
      openModal('modal-reason-detail');
    }

    function getStatusBadgeHTML(t) {
      const statusText = (t['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'] || '').trim();
      if (!statusText) return '-';
      
      if (statusText.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß')) {
          return `<button onclick="showReasonDetail(${t._rowIndex})" class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold hover:bg-green-200 transition-colors flex items-center gap-1 w-max" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                  </button>`;
      }
      if (statusText.includes('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) {
          return `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 w-max">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 
                    ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                  </span>`;
      }
      return `<span class="text-gray-500 truncate block">${statusText}</span>`;
    }

    function addToast(id, msg, status) {
      const c = getEl('toast-container');
      let el = getEl(`toast-${id}`);
      if(!el) {
        el = document.createElement('div');
        el.id = `toast-${id}`;
        c.appendChild(el);
      }
      el.className = `flex items-center gap-3 px-4 py-3 rounded shadow-lg text-sm font-bold text-white animate-slideInRight mb-2 ${status==='syncing'?'bg-blue-600':(status==='success'?'bg-green-600':'bg-red-600')}`;
      el.innerHTML = (status==='syncing' ? `<svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>` : (status==='success'?'‚úÖ':'‚ùå')) + ' ' + msg;
      
      while(c.children.length > 3) c.removeChild(c.firstChild);
      if(status !== 'syncing') { setTimeout(() => { if(el.parentElement) el.parentElement.removeChild(el); }, 4000); }
    }

    async function handleSubmit(type) {
      const pre = type==='receive'?'rec':'dis';
      const date = getEl(`${pre}-date`).value;
      const parts = getEl(`${pre}-parts`).value.trim();
      const prod = getEl(`${pre}-product`).value.trim();
      const qtyStr = getEl(`${pre}-qty`).value;
      
      if(!prod || !qtyStr) return showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 'error');

      if(type === 'receive') {
        const shop = getEl('rec-shop').value.trim();
        if(!shop) return showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 'error');
      }

      if(!state.isOnline) return showAlert("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", 'error');

      const btn = getEl(`btn-save-${pre}`);
      if(btn.disabled) return;

      if(type==='dispatch') {
        const veh = getEl('dis-vehicle').value.trim();
        if(!veh) return showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 'error'); 

        const bal = state.inventory[prod]?.balance || 0;
        if(parseFloat(qtyStr) > bal) return showAlert(`‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å!\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (${qtyStr}) ‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${bal})`, 'error');
        
        const tarL = state.itemSettings[prod]?.lifespan;
        if(veh && tarL) {
          const past = state.transactions.filter(t => {
             const tVeh = (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'] || '').trim();
             return t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()===prod && tVeh===veh;
          }).sort((a,b)=>{
             const dDiff = new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
             return dDiff !== 0 ? dDiff : (b._rowIndex || 0) - (a._rowIndex || 0); // ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
          });
          
          if(past.length > 0) {
             const diffDays = (new Date(date) - new Date(past[0]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']))/86400000;
             const ms = diffDays/30.44;
             if(diffDays >= 0 && ms < parseFloat(tarL)) {
                let timeText = diffDays < 30 ? `${Math.floor(diffDays)} ‡∏ß‡∏±‡∏ô` : `${ms.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                
                return showConfirm(`‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å!\n‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${veh} ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ö‡∏¥‡∏Å "${prod}" ‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${past[0]['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}\n‡∏ã‡∏∂‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${tarL} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡πÇ‡∏î‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${timeText}\n‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≥?`, () => doSubmit(type, true));
             }
          }
        }
      }
      doSubmit(type, false);
    }

    async function doSubmit(type, isAlertPending) {
      const pre = type==='receive'?'rec':'dis';
      const btn = getEl(`btn-save-${pre}`);
      btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      
      let prod = getEl(`${pre}-product`).value.trim();
      let parts = getEl(`${pre}-parts`).value.trim();
      
      // ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏õ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ
      if(type==='dispatch' && !parts && state.inventory[prod]?.mainPart) parts = state.inventory[prod].mainPart;

      const maxId = state.transactions.length > 0 ? Math.max(...state.transactions.map(t=>t._rowIndex||0)) : 1;
      const newTx = {
        action: 'saveTransaction', _rowIndex: maxId+1,
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': getEl(`${pre}-date`).value, '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': type==='receive'?'‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤':'‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å',
        '‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': parts, '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': prod, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': parseFloat(getEl(`${pre}-qty`).value),
        '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°': type==='receive'?parseFloat(getEl('rec-price').value||0):'', '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤': type==='receive'?getEl('rec-shop').value:'',
        '‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ': type==='dispatch'?getEl('dis-vehicle').value:'', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô': isAlertPending?'‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö':'',
        '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•': '', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢': ''
      };

      state.transactions.unshift(newTx);
      computeDerivedState(); 
      
      getEl(`${pre}-product`).value = ''; getEl(`${pre}-parts`).value = ''; getEl(`${pre}-qty`).value = '';
      if(type==='receive') { getEl('rec-price').value=''; getEl('rec-shop').value=''; }
      if(type==='dispatch') { getEl('dis-vehicle').value=''; getEl('dis-stock-warning').classList.add('hidden'); getEl('dis-lifespan-warning').classList.add('hidden'); }
      
      showAlert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
      const tId = Date.now();
      addToast(tId, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...", "syncing");

      try {
        await fetchWithTimeout(WEB_APP_URL, { method: 'POST', body: JSON.stringify(newTx) });
        addToast(tId, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      } catch(e) {
        addToast(tId, "‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)", "error");
      }
      btn.disabled = false; btn.innerText = type==='receive'?"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å":"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å";
    }

    function renderAllTables() {
      if(state.activeTab==='summary') renderSummary();
      if(state.activeTab==='shops') renderShops();
      if(state.activeTab==='history') renderHistory();
      if(state.activeTab==='alerts') renderAlerts();
      
      const badge = getEl('alert-badge');
      const count = state.alertData.length + state.lowStockAlerts.length;
      if(count > 0) { badge.classList.remove('hidden'); badge.innerText = count; } else badge.classList.add('hidden');
      
      localStorage.setItem('cachedTransactions_v14', JSON.stringify(state.transactions));
    }

    function renderSummary() {
      const src = getEl('summary-search').value.toLowerCase();
      const arr = state.existingProducts.filter(p => {
         if(p.toLowerCase().includes(src)) return true;
         const codes = Array.from(state.inventory[p].partsCodes);
         return codes.some(c => c.toLowerCase().includes(src));
      });
      
      const tb = getEl('summary-tbody');
      if(arr.length===0) return tb.innerHTML = `<tr><td colspan="2" class="px-6 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>`;
      
      tb.innerHTML = arr.map(p => {
        const inv = state.inventory[p];
        const set = state.itemSettings[p] || {};
        const low = inv.balance <= (parseFloat(set.minStock)||0) && set.minStock ? 'text-red-600' : 'text-blue-700';
        const allCodes = Array.from(inv.partsCodes).join(', ');
        
        return `<tr class="hover:bg-blue-50 cursor-pointer transition-colors" onclick="openDetail('${p.replace(/'/g, "\\'")}')">
          <td class="px-6 py-4 text-sm font-semibold text-gray-900">
            <div class="flex flex-wrap items-center gap-2">${p}
              ${set.lifespan ? `<span class="text-xs font-normal bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full whitespace-nowrap">‡∏≠‡∏≤‡∏¢‡∏∏: ${set.lifespan} ‡∏î.</span>`:''}
              ${set.minStock ? `<span class="text-xs font-normal bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full whitespace-nowrap">&le; ${set.minStock}</span>`:''}
            </div>
            ${allCodes ? `<div class="text-xs text-gray-500 mt-1 font-normal break-all">‡∏û‡∏≤‡∏£‡πå‡∏ó: ${allCodes}</div>`:''}
          </td>
          <td class="px-6 py-4 text-sm text-right font-bold bg-blue-50/30 ${low}">${inv.balance}</td>
        </tr>`;
      }).join('');
    }

    function renderShops() {
      const shop = getEl('shops-select').value;
      const c = getEl('shops-table-container');
      if(!shop) return c.classList.add('hidden');
      c.classList.remove('hidden');
      
      const txs = state.transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' && t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']===shop).sort((a,b)=>new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
      getEl('shops-tbody').innerHTML = txs.map(t => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 text-sm">${t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td><td class="px-4 py-3 text-sm font-medium">${t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</td><td class="px-4 py-3 text-sm text-right font-bold">${t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}</td><td class="px-4 py-3 text-sm text-right text-green-600">${t['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°']?parseFloat(t['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°']).toLocaleString()+' ‡∏ø':'-'}</td></tr>`).join('');
      getEl('shops-total').innerHTML = `‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: ${txs.reduce((s,t)=>s+(parseFloat(t['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°'])||0),0).toLocaleString()} ‡∏ø`;
    }

    function renderHistory() {
      const type = getEl('hist-type').value;
      const prod = getEl('hist-product').value;
      const veh = getEl('hist-vehicle').value;
      const sD = getEl('hist-start').value;
      const eD = getEl('hist-end').value;

      const txs = state.transactions.filter(t => {
        if(type!=='all' && t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']!==type) return false;
        if(prod && (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()!==prod) return false;
        if(veh && (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']||t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å']||'')!==veh) return false;
        if(sD && t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']<sD) return false;
        if(eD && t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']>eD) return false;
        return true;
      }).sort((a,b)=>new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));

      getEl('history-tbody').innerHTML = txs.map(t => `<tr class="hover:bg-gray-50">
        <td class="px-3 py-3 text-sm text-gray-600">${t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td>
        <td class="px-3 py-3 text-sm"><span class="px-2 py-1 text-xs rounded-full ${t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'?'bg-green-100 text-green-800':'bg-orange-100 text-orange-800'}">${t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']}</span></td>
        <td class="px-3 py-3 text-sm font-medium">${t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} <span class="text-xs text-gray-400 block">${t['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']||''}</span></td>
        <td class="px-3 py-3 text-sm text-right font-bold">${t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}</td>
        <td class="px-3 py-3 text-sm text-gray-500">${t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'?(t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']||'-'):(t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']||t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å']||'-')}</td>
        <td class="px-3 py-3 text-xs text-gray-500 max-w-[150px] truncate">${getStatusBadgeHTML(t)}</td>
        <td class="px-3 py-3 text-center whitespace-nowrap">
           <button onclick='openEdit(${t._rowIndex})' class="text-blue-500 mx-1 bg-blue-50 p-1.5 rounded">‚úèÔ∏è</button>
           <button onclick='cmdDelete(${t._rowIndex})' class="text-red-500 mx-1 bg-red-50 p-1.5 rounded">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
    }

    function renderAlerts() {
      const lb = getEl('alerts-lowstock-tbody');
      if(state.lowStockAlerts.length===0) lb.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">‚úÖ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥</td></tr>`;
      else lb.innerHTML = state.lowStockAlerts.map(a => `<tr class="hover:bg-orange-50"><td class="px-4 py-3 text-sm text-gray-500">${a.partsCode||'-'}</td><td class="px-4 py-3 text-sm font-bold text-gray-900">${a.product}</td><td class="px-4 py-3 text-sm text-center text-gray-600">&le; ${a.threshold}</td><td class="px-4 py-3 text-sm text-right font-bold text-red-600">${a.balance}</td></tr>`).join('');

      const db = getEl('alerts-dispatch-tbody');
      if(state.alertData.length===0) db.innerHTML = `<tr><td colspan="5" class="px-4 py-12 text-center text-gray-500">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</td></tr>`;
      else db.innerHTML = state.alertData.map((t,i) => `<tr class="hover:bg-red-50 transition-colors"><td class="px-4 py-3 text-sm font-medium text-gray-900">${t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td><td class="px-4 py-3 text-sm font-bold text-orange-600">${t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']}</td><td class="px-4 py-3 text-sm font-medium text-gray-900">${t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} <span class="text-xs text-gray-500">(${t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']} ‡∏ä‡∏¥‡πâ‡∏ô)</span></td><td class="px-4 py-3 text-center text-sm"><button onclick='showAlertDetail(${i})' class="text-blue-600 underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td><td class="px-4 py-3 text-right"><button onclick='openPrompt(${i})' class="bg-green-600 text-white px-3 py-1.5 rounded text-xs shadow-sm">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button></td></tr>`).join('');
    }

    function openDetail(productName) {
      if(!productName) return;
      state.detailItem = productName;
      const elTitle = getEl('detail-title');
      if(elTitle) elTitle.innerText = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${productName}`;
      
      const elBal = getEl('detail-balance');
      if(elBal) elBal.innerText = `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${state.inventory[productName].balance}`;
      
      const elBal2 = getEl('detail-balance-2');
      if(elBal2) elBal2.innerText = `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${state.inventory[productName].balance}`;
      
      getEl('detail-lifespan').value = state.itemSettings[productName]?.lifespan || '';
      getEl('detail-minstock').value = state.itemSettings[productName]?.minStock || '';
      getEl('detail-filter').value = 'all';
      closeGlobalRename();
      renderDetailTable();
      openModal('modal-detail');
    }

    function renderDetailTable() {
      const f = getEl('detail-filter').value;
      const txs = state.transactions.filter(t => (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()===state.detailItem && (f==='all'||t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']===f)).sort((a,b)=>new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])-new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
      getEl('detail-tbody').innerHTML = txs.map(t => `<tr class="hover:bg-gray-50"><td class="px-4 py-2 text-sm">${t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td><td class="px-4 py-2 text-sm"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs">${t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']}</span></td><td class="px-4 py-2 text-sm text-right font-bold">${t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}</td><td class="px-4 py-2 text-sm">${t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'?(t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']||'-'):(t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']||t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å']||'-')}</td><td class="px-4 py-2 text-sm">${getStatusBadgeHTML(t)}</td><td class="px-4 py-2 text-center"><button onclick='openEdit(${t._rowIndex})' class="mx-1 text-xl">üìù</button><button onclick='cmdDelete(${t._rowIndex})' class="mx-1 text-xl text-red-500">üóëÔ∏è</button></td></tr>`).join('');
    }

    async function saveSettings() {
      const ls = getEl('detail-lifespan').value;
      const ms = getEl('detail-minstock').value;
      const btn = getEl('btn-save-settings');
      btn.innerText="‡∏£‡∏≠..."; btn.disabled=true;
      
      state.itemSettings[state.detailItem] = {lifespan: ls, minStock: ms};
      computeDerivedState(); 
      
      const tId = Date.now(); addToast(tId, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", "syncing");
      try {
        await fetchWithTimeout(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'saveLifespan', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤':state.detailItem, '‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':ls, '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥':ms})});
        addToast(tId, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      } catch(e) { addToast(tId, "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
      btn.innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"; btn.disabled=false;
    }

    function openGlobalRename() {
      getEl('detail-header-normal').classList.add('hidden');
      getEl('detail-header-rename').classList.remove('hidden');
      getEl('rename-name').value = state.detailItem;
      
      const partsContainer = getEl('rename-parts-container');
      const codes = Array.from(state.inventory[state.detailItem]?.partsCodes || []).filter(Boolean);
      
      if (codes.length === 0) {
         partsContainer.innerHTML = `
            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
               <label class="text-sm font-bold text-gray-700 sm:w-20">‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà:</label>
               <input type="text" class="rename-part-input p-2 border rounded text-sm flex-1 w-full" data-old="" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡∏°‡πà" />
            </div>`;
      } else {
         partsContainer.innerHTML = codes.map((code, idx) => `
            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
               <label class="text-sm font-bold text-gray-700 sm:w-20">‡∏û‡∏≤‡∏£‡πå‡∏ó ${idx + 1}:</label>
               <input type="text" class="rename-part-input p-2 border rounded text-sm flex-1 w-full" data-old="${code.replace(/"/g, '&quot;')}" value="${code.replace(/"/g, '&quot;')}" />
            </div>
         `).join('');
      }
    }
    
    function closeGlobalRename() {
      getEl('detail-header-rename').classList.add('hidden');
      getEl('detail-header-normal').classList.remove('hidden');
    }
    
    async function executeGlobalRename() {
      const nName = getEl('rename-name').value.trim();
      if(!nName) return showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "error");
      
      const partInputs = document.querySelectorAll('.rename-part-input');
      const partsMapping = {};
      partInputs.forEach(input => {
          const oldP = input.getAttribute('data-old');
          const newP = input.value.trim();
          if (oldP || newP) partsMapping[oldP] = newP;
      });
      
      getEl('btn-rename-save').innerText="‡∏£‡∏≠..."; getEl('btn-rename-save').disabled=true;
      const tId = Date.now(); addToast(tId, "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠/‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö", "syncing");
      
      const old = state.detailItem;
      
      state.transactions = state.transactions.map(t => {
        if ((t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === old) {
            let updated = {...t, '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': nName};
            const oldPart = (t['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']||'').trim();
            if (partsMapping[oldPart] !== undefined) {
                updated['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] = partsMapping[oldPart];
            }
            return updated;
        }
        return t;
      });
      
      if(state.itemSettings[old]) { 
          state.itemSettings[nName] = state.itemSettings[old]; 
          if(old !== nName) delete state.itemSettings[old]; 
      }
      
      state.detailItem = nName;
      computeDerivedState();
      openDetail(nName);

      try {
        await fetchWithTimeout(WEB_APP_URL, {
            method:'POST', 
            body:JSON.stringify({action:'globalRename', oldName:old, newName:nName, partsMapping: partsMapping})
        });
        addToast(tId, "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      } catch(e) { addToast(tId, "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
      
      getEl('btn-rename-save').innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"; getEl('btn-rename-save').disabled=false;
    }

    function openEdit(rowIndex) {
      const tx = state.transactions.find(t => t._rowIndex === rowIndex);
      if(!tx) return;
      state.editingTx = tx;
      getEl('edit-date').value = tx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'];
      getEl('edit-qty').value = tx['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'];
      
      if(tx['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
        getEl('edit-wrap-parts').innerHTML = `<label class="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label><input type="text" id="edit-parts" value="${tx['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']||''}" class="w-full p-2 border focus:ring-blue-500 rounded text-sm"/>`;
        getEl('edit-wrap-product').innerHTML = `<label class="block text-xs font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="edit-product" value="${tx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}" class="w-full p-2 border focus:ring-blue-500 rounded text-sm"/>`;
        getEl('edit-wrap-extra').innerHTML = `
          <div><label class="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</label><input type="number" id="edit-price" value="${tx['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°']||''}" class="w-full p-2 border rounded text-sm"/></div>
          <div><label class="block text-xs font-bold text-gray-700 mb-1">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="edit-shop" value="${tx['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']||''}" class="w-full p-2 border rounded text-sm"/></div>`;
      } else {
        getEl('edit-wrap-parts').innerHTML = `<label class="block text-xs font-bold text-gray-400 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏•‡πá‡∏≠‡∏Å)</label><input type="text" value="${tx['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']||''}" disabled class="w-full p-2 border rounded text-sm bg-gray-100 text-gray-500 cursor-not-allowed"/>`;
        getEl('edit-wrap-product').innerHTML = `<label class="block text-xs font-bold text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡πá‡∏≠‡∏Å)</label><input type="text" value="${tx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}" disabled class="w-full p-2 border rounded text-sm bg-gray-100 text-gray-500 cursor-not-allowed"/>`;
        getEl('edit-wrap-extra').innerHTML = `<div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><input type="text" id="edit-veh" value="${tx['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']||''}" class="w-full p-2 border rounded text-sm"/></div>`;
      }
      openModal('modal-edit');
    }

    async function executeEdit() {
      const tx = state.editingTx;
      const nData = {...tx, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà':getEl('edit-date').value, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô':parseFloat(getEl('edit-qty').value)};
      if(tx['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
        nData['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] = getEl('edit-parts').value; nData['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] = getEl('edit-product').value;
        nData['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°'] = getEl('edit-price').value; nData['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] = getEl('edit-shop').value;
      } else {
        nData['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] = getEl('edit-veh').value;
      }
      
      const btn = getEl('btn-edit-save'); btn.disabled=true; btn.innerText="‡∏£‡∏≠...";
      state.transactions = state.transactions.map(t => t._rowIndex===tx._rowIndex ? nData : t);
      computeDerivedState();
      closeModal('modal-edit');
      
      const tId = Date.now(); addToast(tId, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...", "syncing");
      try {
        await fetchWithTimeout(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'editTransaction', oldData:tx, newData:nData})});
        addToast(tId, "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      } catch(e) { addToast(tId, "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
      btn.disabled=false; btn.innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
    }

    function cmdDelete(rowIndex) {
      const tx = state.transactions.find(t => t._rowIndex === rowIndex);
      if(!tx) return;
      showConfirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö ${tx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${tx['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}?`, async () => {
        state.transactions = state.transactions.filter(t => t._rowIndex !== tx._rowIndex);
        computeDerivedState();
        const tId = Date.now(); addToast(tId, "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", "syncing");
        try {
          await fetchWithTimeout(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'deleteTransaction', oldData:tx})});
          addToast(tId, "‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
        } catch(e) { addToast(tId, "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå", "error"); }
      });
    }

    function showAlertDetail(idx) {
      const tx = state.alertData[idx];
      const txVeh = (tx['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || tx['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'] || '').trim();
      
      const past = state.transactions.filter(t => {
        const tVeh = (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'] || '').trim();
        return t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && 
               (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()===(tx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() && 
               tVeh === txVeh;
      }).sort((a,b) => {
        const dDiff = new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
        if (dDiff !== 0) return dDiff;
        return (b._rowIndex || 0) - (a._rowIndex || 0); 
      });
      
      const currentIndex = past.findIndex(t => t._rowIndex === tx._rowIndex);
      const pTx = currentIndex !== -1 && currentIndex + 1 < past.length ? past[currentIndex + 1] : null;
      
      const c = getEl('alert-detail-content');
      if(pTx) {
        const diffDays = ((new Date(tx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(pTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']))/86400000);
        let timeText = diffDays < 30 ? `${Math.floor(diffDays)} ‡∏ß‡∏±‡∏ô` : `${(diffDays/30.44).toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
        c.innerHTML = `<p>‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: <b>${txVeh}</b></p><p>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ${pTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</p><p>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ: ${tx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</p><p class="text-red-500 font-bold">‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${timeText} (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${state.itemSettings[tx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].trim()]?.lifespan} ‡∏î.)</p>`;
      } else {
        c.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)</p>";
      }
      
      openModal('modal-alert-detail');
    }

    function openPrompt(idx) {
      state.promptTx = state.alertData[idx];
      getEl('prompt-reason').value = ''; getEl('prompt-checker').value = '';
      openModal('modal-prompt');
    }

    async function executePrompt() {
      const chk = getEl('prompt-checker').value.trim();
      const rsn = getEl('prompt-reason').value.trim();
      if(!chk) return showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö", "error");
      
      const tx = state.promptTx;
      getEl('btn-prompt-save').innerText="‡∏£‡∏≠..."; getEl('btn-prompt-save').disabled=true;
      
      state.transactions = state.transactions.map(t => {
        if(t._rowIndex === tx._rowIndex) return {...t, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô':'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•':rsn||'-', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢':chk};
        return t;
      });
      computeDerivedState();
      closeModal('modal-prompt');
      
      const tId = Date.now(); addToast(tId, "‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...", "syncing");
      try {
        await fetchWithTimeout(WEB_APP_URL, {method:'POST', body:JSON.stringify({action:'clearAlert', _rowIndex:tx._rowIndex, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà':'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•':rsn||'-', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢':chk, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà':tx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'], '‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ':tx['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'], '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤':tx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'], '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô':tx['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']})});
        addToast(tId, "‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      } catch(e) { addToast(tId, "‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
      getEl('btn-prompt-save').innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; getEl('btn-prompt-save').disabled=false;
    }

    function openScanner(origin) {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
         showAlert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏ú‡πà‡∏≤‡∏ô HTTPS / Localhost", "error");
         return;
      }
      
      state.scannerOrigin = origin;
      getEl('modal-scanner').classList.remove('hidden');

      setTimeout(() => {
        try { if (state.html5QrcodeScanner) state.html5QrcodeScanner.clear(); } catch(e){}

        state.html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
        
        state.html5QrcodeScanner.render((txt) => {
          if(state.scannerOrigin === 'summary') {
             getEl('summary-search').value = txt;
             renderSummary();
             closeScanner();
             showAlert(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${txt}`, 'success');
          } else {
             getEl(`${state.scannerOrigin}-parts`).value = txt;
             handlePartsChange(state.scannerOrigin);
             closeScanner();
             showAlert(`‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${txt}`, 'success');
          }
        }, (err) => {});
      }, 150);
    }
    
    function closeScanner() {
      if (state.html5QrcodeScanner) {
        state.html5QrcodeScanner.clear().then(() => {
          getEl('modal-scanner').classList.add('hidden');
          getEl('reader').innerHTML = ''; 
          state.html5QrcodeScanner = null;
        }).catch(err => {
          getEl('modal-scanner').classList.add('hidden');
          state.html5QrcodeScanner = null;
        });
      } else {
        getEl('modal-scanner').classList.add('hidden');
      }
    }
  </script>
</body>
</html>